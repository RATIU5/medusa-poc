---
import {medusa} from "../../lib/medusa";
import ProductSelect from "./_components/ProductSelect.svelte";
import type { ProductOption, ProductVariant } from "./_utils/types";

export const prerender = false;

const { productSlug } = Astro.params;

if (!productSlug) {
  return new Response("Not Found", { status: 404 });
}

const productList = await medusa.products.list({handle: productSlug});

if (productList.products.length === 0) {
  return new Response("Not Found", { status: 404 });
}

if (productList.products.length > 1) {
  return new Response("Multiple categories found", { status: 404 });
}

const product = productList.products[0];

if (!product) {
  return new Response("Not Found", { status: 404 });
}

const filteredProduct = {
  title: product.title,
  subtitle: product.subtitle,
  description: product.description,
  thumbnail: product.thumbnail,
  options: product.options.map((option) => {
    return {
      id: option.id,
      title: option.title,
      values: option.values,
    };
  }),
  variants: product.variants.map((variant) => {
    return {
      id: variant.id,
      title: variant.title,
      price: variant.price,
      sku: variant.sku,
      options: variant.options,
    };
  }),
};

---
<h1>{product.title}</h1>
<p>{product.subtitle}</p>

<p>{product.description}</p>

<img src={product.thumbnail} alt={product.title} />

<ProductSelect {product} />